<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissions Data Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- ... Previous HTML content ... -->

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <div class="flex justify-center items-center py-12">
                <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mt-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="error-message"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cache DOM elements
        const searchForm = document.getElementById('searchForm');
        const identifierType = document.getElementById('identifier-type');
        const identifierInput = document.getElementById('identifier');
        const identifierLabel = document.getElementById('identifier-label');
        const companyPreview = document.getElementById('company-preview');
        const companyNameDisplay = document.getElementById('company-name-display');
        const validationMessage = document.getElementById('validation-message');
        const loadingElement = document.getElementById('loading');
        const resultsElement = document.getElementById('results');
        const errorElement = document.getElementById('error');
        const errorMessageElement = document.getElementById('error-message');

        // ISIN validation timeout
        let isinValidationTimeout = null;

        // Update UI based on identifier type
        identifierType.addEventListener('change', () => {
            const isISIN = identifierType.value === 'isin';
            identifierLabel.textContent = isISIN ? 'Enter ISIN' : 'Enter Company Name';
            companyPreview.classList.add('hidden');
            validationMessage.classList.add('hidden');
            identifierInput.value = '';
        });

        // Real-time ISIN validation and company lookup
        identifierInput.addEventListener('input', async (e) => {
            if (identifierType.value !== 'isin') return;

            clearTimeout(isinValidationTimeout);
            const isin = e.target.value.trim().toUpperCase();

            if (isin.length === 12) {
                isinValidationTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/validate-isin/${isin}`);
                        const data = await response.json();

                        if (data.valid) {
                            companyNameDisplay.textContent = data.company_name;
                            companyPreview.classList.remove('hidden');
                            validationMessage.classList.add('hidden');
                        } else {
                            validationMessage.textContent = data.error;
                            validationMessage.classList.remove('hidden');
                            companyPreview.classList.add('hidden');
                        }
                    } catch (error) {
                        validationMessage.textContent = 'Error validating ISIN';
                        validationMessage.classList.remove('hidden');
                        companyPreview.classList.add('hidden');
                    }
                }, 500);
            } else {
                companyPreview.classList.add('hidden');
                if (isin.length > 0) {
                    validationMessage.textContent = 'ISIN must be exactly 12 characters';
                    validationMessage.classList.remove('hidden');
                } else {
                    validationMessage.classList.add('hidden');
                }
            }
        });

        // Form submission
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const identifier = identifierInput.value.trim();
            const idType = identifierType.value;
            
            if (!identifier) return;

            // Show loading, hide results and error
            loadingElement.classList.remove('hidden');
            resultsElement.classList.add('hidden');
            errorElement.classList.add('hidden');
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        identifier: identifier,
                        id_type: idType
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to analyze emissions data');
                }
                
                // Update company info
                const companyDetails = document.getElementById('company-details');
                companyDetails.innerHTML = `
                    <p><strong>Company:</strong> ${data.company}</p>
                    ${data.original_isin ? `<p><strong>ISIN:</strong> ${data.original_isin}</p>` : ''}
                    <p><strong>Report Year:</strong> ${data.report_year}</p>
                `;

                // Update results display
                document.getElementById('json-display').textContent = JSON.stringify(data.emissions_data, null, 2);
                resultsElement.classList.remove('hidden');
                
            } catch (error) {
                errorMessageElement.textContent = error.message;
                errorElement.classList.remove('hidden');
            } finally {
                loadingElement.classList.add('hidden');
            }
        });

        // Download functionality
        function downloadData(format) {
            const data = JSON.parse(document.getElementById('json-display').textContent);
            const company = document.getElementById('company-details').querySelector('p').textContent.split(':')[1].trim();
            
            if (format === 'json') {
                downloadJson(data, company);
            } else if (format === 'csv') {
                downloadCsv(data, company);
            }
        }

        function downloadJson(data, company) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${company.toLowerCase().replace(/\s+/g, '_')}_emissions.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadCsv(data, company) {
            // Convert emissions data to CSV format
            const rows = [];
            rows.push(['Metric', 'Value', 'Unit']);
            
            if (data.scope_1) {
                rows.push(['Scope 1', data.scope_1.value, data.scope_1.unit]);
            }
            if (data.scope_2) {
                rows.push(['Scope 2', data.scope_2.value, data.scope_2.unit]);
            }
            if (data.scope_2_market_based) {
                rows.push(['Scope 2 (Market-based)', data.scope_2_market_based.value, data.scope_2_market_based.unit]);
            }
            if (data.scope_2_location_based) {
                rows.push(['Scope 2 (Location-based)', data.scope_2_location_based.value, data.scope_2_location_based.unit]);
            }

            const csvContent = rows.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${company.toLowerCase().replace(/\s+/g, '_')}_emissions.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>